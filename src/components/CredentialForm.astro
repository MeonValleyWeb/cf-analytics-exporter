---
// CredentialForm - handles API token and Zone ID input with validation
---

<div id="credential-form-container">
  <form id="credential-form" class="space-y-6">
    <div>
      <label for="apiToken" class="block text-sm font-medium text-gray-700">
        Cloudflare API Token
      </label>
      <input
        type="password"
        id="apiToken"
        name="apiToken"
        required
        placeholder="Enter your API token"
        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"
      />
      <p class="mt-1 text-xs text-gray-500">
        Create a token with <code class="bg-gray-100 px-1 rounded">Zone.Analytics</code> read permission.
        <a
          href="https://developers.cloudflare.com/fundamentals/api/get-started/create-token/"
          target="_blank"
          rel="noopener noreferrer"
          class="text-orange-600 hover:underline"
        >
          Learn how
        </a>
      </p>
    </div>

    <div>
      <label for="zoneId" class="block text-sm font-medium text-gray-700">
        Zone ID
      </label>
      <input
        type="text"
        id="zoneId"
        name="zoneId"
        required
        placeholder="e.g., 023e105f4ecef8ad9ca31a8372d0c353"
        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500 font-mono text-sm"
      />
      <p class="mt-1 text-xs text-gray-500">
        Find this in your Cloudflare dashboard under your domain's Overview page.
      </p>
    </div>

    <div id="form-alert" class="hidden"></div>

    <button
      type="submit"
      id="submit-btn"
      class="w-full rounded-md bg-orange-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-orange-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Validate & Connect
    </button>
  </form>
</div>

<script>
  const form = document.getElementById('credential-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const alertDiv = document.getElementById('form-alert') as HTMLDivElement;
  const apiTokenInput = document.getElementById('apiToken') as HTMLInputElement;
  const zoneIdInput = document.getElementById('zoneId') as HTMLInputElement;

  // Load existing credentials if available
  const stored = localStorage.getItem('cf_credentials');
  if (stored) {
    try {
      const creds = JSON.parse(stored);
      if (creds.zoneId) {
        zoneIdInput.value = creds.zoneId;
      }
    } catch (e) {
      // Ignore parse errors
    }
  }

  function showAlert(message: string, type: 'error' | 'success') {
    alertDiv.className = type === 'error'
      ? 'rounded-md bg-red-50 border border-red-200 p-4 text-sm text-red-700'
      : 'rounded-md bg-green-50 border border-green-200 p-4 text-sm text-green-700';
    alertDiv.textContent = message;
    alertDiv.classList.remove('hidden');
  }

  function hideAlert() {
    alertDiv.classList.add('hidden');
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideAlert();

    const apiToken = apiTokenInput.value.trim();
    const zoneId = zoneIdInput.value.trim();

    if (!apiToken || !zoneId) {
      showAlert('Please fill in both fields', 'error');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Validating...';

    try {
      const res = await fetch('/.netlify/functions/validate-token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ apiToken, zoneId })
      });

      const data = await res.json();

      if (data.valid) {
        // Store credentials locally
        localStorage.setItem('cf_credentials', JSON.stringify({
          apiToken,
          zoneId: data.zoneId,
          zoneName: data.zoneName
        }));

        showAlert(`Connected to ${data.zoneName}`, 'success');

        // Dispatch custom event for parent components
        window.dispatchEvent(new CustomEvent('credentials-validated', {
          detail: { zoneName: data.zoneName, zoneId: data.zoneId }
        }));
      } else {
        showAlert(data.error || 'Validation failed', 'error');
      }
    } catch (err) {
      showAlert('Network error. Please try again.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Validate & Connect';
    }
  });
</script>
